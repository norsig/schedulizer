/**
 * calendarjs
 * @version 0.1.1
 */
var calendarFlow=angular.module("calendar-flow",["calendar-templates"]);calendarFlow.controller("MainController",function(){}),calendarFlow.controller("CalendarController",function($timeout,$scope,GenerativeJobQueue,DateUtils,DaysSelection){function hasPositiveHeight(element){return null!==element&&null!==element.outerHeight()&&element.outerHeight()>0}function getCellHeight(){return hasPositiveHeight(weekElements)||(weekElements=$scope.calendarElem.find(".cf-week")),hasPositiveHeight(weekElements)?weekElements.outerHeight()+4:(weekElements=null,null)}function computeNumberOfWeeks(firstDay){for(var lastDay=DateUtils.plusDays(firstDay,27);1!=lastDay.getDate();)lastDay=DateUtils.nextDay(lastDay);lastDay=DateUtils.lastSunday(lastDay);var days=DateUtils.differenceInDays(firstDay,lastDay);return Math.ceil(days/7)}function createMonth(day,nweeks){return{number:day.getMonth(),name:DateUtils.getMonthName(day),year:day.getFullYear(),nweeks:nweeks}}function createWeek(day){return{loaded:!1,pending:!1,month:createMonth(day,0),firstOfTheMonth:!1,days:[]}}function createMonthByFirstDay(day01){var nweeks=computeNumberOfWeeks(day01);return createMonth(day01,nweeks)}function pushDayIntoWeek(week,date){week.days.push({selected:!1,previousSelectedState:!1,content:null,date:DateUtils.clone(date)})}function setLoadAreaByScroll(scroll){var n=$scope.calendar.length,i=Math.floor(scroll.top*n/scroll.total),j=Math.floor(scroll.bottom*n/scroll.total),m=Math.floor((i+j)/2),a=j-i+1;nextLoadArea={i:m,j:m+1,a:a}}function trySetLoadAreaByLastScroll(){null!==currentScroll&&setLoadAreaByScroll(currentScroll)}function isValidArea(i,j){return null!==i&&null!==j&&j>=i}function markAsLoaded(weeks){_.each(weeks,function(week){week.loaded=!0,loadedWeeks.push(week)})}function unloadWeeks(weeks){_.each(weeks,function(week){week.loaded=!1,_.each(week.days,function(day){day.content=null})}),loadedWeeks=_.difference(loadedWeeks,weeks)}function markAsPending(weeks){_.each(weeks,function(week){week.pending=!0,pendingWeeks.push(week)})}function unsetPendingWeeks(weeks){_.each(weeks,function(week){week.pending=!1}),pendingWeeks=_.difference(pendingWeeks,weeks)}function onDayContentLoaded(days,weeks,error,id){if(!_.contains(authorizedRequests,id))return unloadWeeks(weeks),!1;if(unsetPendingWeeks(weeks),error){trySetLoadAreaByLastScroll();var stop=Math.random()<.63894;return stop}return markAsLoaded(weeks),!1}function loadDayContent(terminator,i,j){var id={};authorizedRequests.push(id);var weeks=$scope.calendar.slice(i,j+1),days=_.chain(weeks).map("days").flatten().value();if(markAsPending(weeks),days.length>0&&null!==$scope.onLoadDayContent){var wrappedTerminator=function(error){var stop=onDayContentLoaded(days,weeks,error,id);terminator(stop)};$scope.onLoadDayContent(wrappedTerminator,days)}else terminator(!0)}function nextUnloadedWeek(i){for(var n=$scope.calendar.length;n>i;i++){var w=$scope.calendar[i];if(!w.loaded&&!w.pending)return i}return null}function previousUnloadedWeek(i){for(;i>=0;i--){var w=$scope.calendar[i];if(!w.loaded&&!w.pending)return i}return null}function initializeCalendar(){for(var i=1;INITIAL_MONTHS_SHOWN>=i;i++)i<=Math.ceil(INITIAL_MONTHS_SHOWN/2)?$scope.loadNextMonth():$scope.loadPreviousMonth();$timeout(function(){$scope.api.goToToday(0)})}function getDay(date){var w=getWeekIndex(date),day=$scope.calendar[w].days[date.getDay()];return DateUtils.equalsDate(date,day.date)||console.log("Error! CalendarController getDay() not working"),day}function getWeekIndex(date){var days=DateUtils.differenceInDays(DateUtils.lastSunday(firstDay),date);return Math.floor(days/7)}function dayRange(a,b){var dates=DaysSelection.dateRange(a.date,b.date);return _.map(dates,function(date){return getDay(date)})}function onSelectDays(){$scope.onSelectDaysParent(selection)}function isCtrl(e){return e.ctrlKey||e.metaKey}function onStateUpdate(){var e=state.event;switch(state){case States.DOWN:isCtrl(e)||selection.clear();break;case States.CLICKED:var day=state.day;if(e.shiftKey)if(null!==twoStepStart){var range=dayRange(twoStepStart,day);selection.select(range)}else selection.select([day]),twoStepStart=day;else day.selected&&isCtrl(e)?(selection.unselect([day]),twoStepStart=null):day.selected||(selection.select([day]),twoStepStart=day);state=States.IDLE;break;case States.DRAGGED:state=States.IDLE;break;case States.DRAGGING:if(null!==state.previous){var previousRange=dayRange(state.start,state.previous);selection.resetToPreviousState(previousRange)}var currentRange=dayRange(state.start,state.current);selection.select(currentRange),twoStepStart=null}state!=States.DOWN&&onSelectDays()}var INITIAL_MONTHS_SHOWN=15,WEEKS_OFFSET=2;void 0===$scope.onSelectDaysParent&&($scope.onSelectDaysParent=function(){}),void 0===$scope.onHoverDayParent&&($scope.onHoverDayParent=function(){}),void 0===$scope.onLoadDayContent&&($scope.onLoadDayContent=function(t){t()}),void 0===$scope.providedCellClass&&($scope.providedCellClass=""),$scope.api={},$scope.calendar=[],void 0===$scope.showHover&&($scope.showHover=!0);var baseCellClasses=function(day){return{"cf-empty":!day.content,"cf-even":day.date.getMonth()%2===0,"cf-odd":day.date.getMonth()%2===1,"cf-today":DateUtils.isToday(day.date),"cf-selected":day.selected}};$scope.cellClass=function(day,week){var classes=baseCellClasses(day,week);return null!==$scope.providedCellClass&&_.extend(classes,$scope.providedCellClass({day:day,week:week})),classes};var firstDay=DateUtils.lastSunday(DateUtils.firstDayOfThisMonth()),lastDay=DateUtils.clone(firstDay),loadedWeeks=[],pendingWeeks=[],weekElements=null;$scope.loadPreviousMonth=function(){for(var isBeginningOfMonth=!1;!isBeginningOfMonth;){firstDay=DateUtils.plusWeeks(firstDay,-1);for(var currentWeek=createWeek(firstDay),i=0;7>i;i++)1==firstDay.getDate()&&(isBeginningOfMonth=!0,currentWeek.firstOfTheMonth=!0,currentWeek.month=createMonthByFirstDay(firstDay)),pushDayIntoWeek(currentWeek,firstDay),firstDay=DateUtils.nextDay(firstDay);$scope.calendar.length>0&&(currentWeek.nextUnloadedWeek=$scope.calendar[0],$scope.calendar[0].previousUnloadedWeek=currentWeek),$scope.calendar.unshift(currentWeek),firstDay=DateUtils.plusWeeks(firstDay,-1)}return getCellHeight()*$scope.calendar[0].month.nweeks},$scope.loadNextMonth=function(){var isBeginningOfMonth=!1;for($scope.calendar.length>0&&(lastWeek=$scope.calendar[$scope.calendar.length-1],lastWeek.month.name=DateUtils.getMonthName(lastDay),lastWeek.month.year=lastDay.getFullYear());!isBeginningOfMonth;){for(var currentWeek=createWeek(lastDay),i=0;7>i;i++)1==lastDay.getDate()&&(isBeginningOfMonth=!0,currentWeek.firstOfTheMonth=!0,currentWeek.month=createMonthByFirstDay(lastDay)),pushDayIntoWeek(currentWeek,lastDay),lastDay=DateUtils.nextDay(lastDay);var n=$scope.calendar.length;n>0&&($scope.calendar[n-1].nextUnloadedWeek=currentWeek,currentWeek.previousUnloadedWeek=$scope.calendar[n-1]),$scope.calendar.push(currentWeek)}$scope.calendar[$scope.calendar.length-1].month.name=""};var nextLoadArea=null,currentScroll=null;$scope.onScroll=function(top,bottom,total){currentScroll={top:top,bottom:bottom,total:total},setLoadAreaByScroll(currentScroll),contentQueue.trigger()};var contentQueue=new GenerativeJobQueue({bottleneck:2,executor:function(terminate){if(null===nextLoadArea)return terminate(!0);var a={valid:!1};a.j=previousUnloadedWeek(nextLoadArea.i),null!==a.j&&(a.i=Math.max(0,a.j-2*nextLoadArea.a),a.i=nextUnloadedWeek(a.i),a.valid=isValidArea(a.i,a.j)),a.valid&&(nextLoadArea.i=a.i);var b={valid:!1};if(b.i=nextUnloadedWeek(nextLoadArea.j),null!==b.i&&(b.j=Math.min($scope.calendar.length-1,b.i+2*nextLoadArea.a),b.j=previousUnloadedWeek(b.j),b.valid=isValidArea(b.i,b.j)),b.valid&&(nextLoadArea.j=b.j),!a.valid&&!b.valid)return terminate(!0);var i=a.valid+b.valid,stop=!0,doubleTerminator=function(localStop){stop=stop&&localStop,0===--i&&terminate(stop)};a.valid&&loadDayContent(doubleTerminator,a.i,a.j),b.valid&&loadDayContent(doubleTerminator,b.i,b.j)}}),authorizedRequests=[];$scope.api.invalidateContent=function(){unloadWeeks(loadedWeeks),unsetPendingWeeks(pendingWeeks),authorizedRequests=[],trySetLoadAreaByLastScroll(),contentQueue.trigger()},$scope.api.loadingStatus=function(){return{weeks:{pending:pendingWeeks.length,loaded:loadedWeeks.length,total:$scope.calendar.length},active:contentQueue.active()}},$scope.api.getDays=function(dates){return _.map(dates,function(date){return getDay(date)})},$scope.api.goToDate=function(date,duration){void 0===duration&&(duration="fast");var weeks=getWeekIndex(date)-WEEKS_OFFSET;if(weeks>=0){var calendarElement=$scope.calendarElem.find(".cf-view-calendar-wrapper"),scroll=getCellHeight()*weeks;0!==duration?calendarElement.animate({scrollTop:scroll},duration):calendarElement[0].scrollTop=scroll}},$scope.api.goToToday=function(duration){$scope.api.goToDate(DateUtils.TODAY,duration)},$scope.showCalendar=!0,$timeout(initializeCalendar),$scope.api.clearSelectedDays=function(){selection.clear(),twoStepStart=null},$scope.api.selectDates=function(dates){var days=$scope.api.getDays(dates);selection.select(days),onSelectDays()};var selection=new DaysSelection,twoStepStart=null,States={IDLE:{},DOWN:{day:null,event:null},CLICKED:{event:null,day:null},DRAGGING:{start:null,current:null,previous:null},DRAGGED:{start:null,end:null}},state=States.IDLE;$scope.onMouseDown=function(day,$event){state==States.IDLE&&(state=States.DOWN,state.day=day,state.event=$event,onStateUpdate())},$scope.showTooltip=!1,$scope.onMouseEnter=function(day){if($scope.showTooltip=void 0!==$scope.tooltip&&void 0!==$scope.tooltip(day)?!0:!1,$scope.onHoverDayParent(day),state==States.DOWN){if(state.day!=day){var start=state.day;state=States.DRAGGING,state.start=start,state.current=day,state.previous=null,onStateUpdate()}}else state==States.DRAGGING&&state.current!=day&&(state.previous=state.current,state.current=day,onStateUpdate())},$scope.onMouseUp=function(day,$event){if(state==States.DOWN)state=States.CLICKED,state.event=$event,state.day=day,onStateUpdate();else if(state==States.DRAGGING){if(state.current!=day)throw"Invalid state";var start=state.day;state=States.DRAGGED,state.start=start,state.end=day,onStateUpdate()}}}),calendarFlow.directive("calendar",function(){return{restrict:"E",scope:{onSelectDaysParent:"=?onSelectDays",onHoverDayParent:"=?onHoverDay",onLoadDayContent:"=?onLoadDayContent",providedCellClass:"&?cellClass",tooltip:"=?getDayTooltip",api:"=?exposeApiTo",showHover:"=?"},link:function(scope,elem){scope.calendarElem=$(elem)},templateUrl:"views/calendar.html",controller:"CalendarController"}}),calendarFlow.factory("DateUtils",[function(){var TODAY=new Date;MS_PER_DAY=864e5;var monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];return{TODAY:TODAY,MS_PER_DAY:MS_PER_DAY,SORT_BY:function(d){return d.getTime()},min:function(a,b){return b>a?a:b},max:function(a,b){return a>b?a:b},isRange:function(dates){if(0===dates.length)return!0;var min=_.min(dates,this.SORT_BY),max=_.max(dates,this.SORT_BY);return this.differenceInDays(min,max)+1==dates.length},fromISOLocalString:function(string){var parts=string.split("-"),d=new Date;return d.setYear(parseInt(parts[0])),d.setMonth(parseInt(parts[1])-1,parseInt(parts[2])),d},firstDayOfThisMonth:function(){var d=new Date(TODAY.getTime());return d.setDate(1),d},plusDays:function(date,days){var d=this.clone(date);return d.setDate(d.getDate()+days),d},plusWeeks:function(date,weeks){return this.plusDays(date,7*weeks)},clone:function(date){return new Date(date.getTime())},differenceInDays:function(from,to){var utc1=Date.UTC(from.getFullYear(),from.getMonth(),from.getDate()),utc2=Date.UTC(to.getFullYear(),to.getMonth(),to.getDate());return Math.floor((utc2-utc1)/MS_PER_DAY)},isToday:function(date){return this.equalsDate(date,TODAY)},nextDay:function(date){return this.plusDays(date,1)},previousDay:function(date){return this.plusDays(date,-1)},lastSunday:function(date){return this.plusDays(date,-date.getDay())},equalsDate:function(date1,date2){return date1.toDateString()==date2.toDateString()},getMonthName:function(date){return monthNames[date.getMonth()]},toISOLocalDateString:function(date){var pad=function(n){return 10>n?"0"+n:n};return date.getFullYear()+"-"+pad(date.getMonth()+1)+"-"+pad(date.getDate())}}}]),calendarFlow.factory("GenerativeJobQueue",[function(){function GenerativeJobQueue(options){this.executor=options.executor,this.bottleneck=options.bottleneck||this.bottleneck}GenerativeJobQueue.prototype.bottleneck=2,GenerativeJobQueue.prototype.pool=[],GenerativeJobQueue.prototype.terminator=function(job,stop){this.pool.splice(this.pool.indexOf(job),1),stop||this.trigger()};var maxJobId=0;return GenerativeJobQueue.prototype.trigger=function(){for(var terminators=[];this.pool.length<this.bottleneck;){var job={id:maxJobId++};this.pool.push(job),terminators.push(this.terminator.bind(this,job))}_.each(terminators,function(terminator){this.executor(terminator)}.bind(this))},GenerativeJobQueue.prototype.active=function(){return this.pool.length>0},GenerativeJobQueue}]),calendarFlow.directive("dayTooltip",function(){return{restrict:"A",scope:{dayTooltip:"@"},link:function(scope,element){var my="left bottom-5",at="left top";$(element).tooltip({content:function(){return $(this).attr("title")},position:{my:my,at:at},show:!1,hide:!1}),scope.$watch("dayTooltip",function(){$(element).tooltip("true"==scope.dayTooltip?"enable":"disable")})}}}),calendarFlow.factory("DaysSelection",["DateUtils",function(DateUtils){function DaysSelection(){this.days=[]}return DaysSelection.prototype.each=function(f){_.each(this.days,f,this)},DaysSelection.prototype.select=function(days){_.each(days,function(day){day.previousSelectedState=day.selected,day.selected=!0,this.contains(day)||this.days.push(day)},this)},DaysSelection.prototype.unselect=function(days){_.each(days,function(day){day.previousSelectedState=day.selected,day.selected=!1,this.contains(day)&&(this.days=_.without(this.days,day))},this)},DaysSelection.prototype.clear=function(){_.each(this.days,function(day){day.previousSelectedState=!0,day.selected=!1},this),this.days=[]},DaysSelection.prototype.contains=function(day){return _.contains(this.days,day)},DaysSelection.prototype.resetToPreviousState=function(days){_.each(days,function(day){day.selected=day.previousSelectedState,day.selected&&!this.contains(day)?this.days.push(day):!day.selected&&this.contains(day)&&(this.days=_.without(this.days,day))},this)},DaysSelection.prototype.dates=function(){return _.map(this.days,function(day){return day.date},this)},DaysSelection.prototype.getDays=function(){return _.clone(this.days)},DaysSelection.dateRange=function(a,b){var i=DateUtils.min(a,b);b=DateUtils.max(a,b);for(var range=[];b>i||DateUtils.equalsDate(i,b);)range.push(i),i=DateUtils.nextDay(i);return range},DaysSelection}]),calendarFlow.directive("scroller",function($timeout){return{restrict:"A",scope:{nextChunkMethod:"=",previousChunkMethod:"=",onScroll:"=",numberOfLoadedChunksPerScroll:"="},link:function($scope,element){var rawElement=element[0];void 0===$scope.numberOfLoadedChunksPerScroll&&($scope.numberOfLoadedChunksPerScroll=1),element.bind("scroll",function(){$timeout(function(){$scope.onScroll(rawElement.scrollTop,rawElement.scrollTop+rawElement.offsetHeight-5,rawElement.scrollHeight),rawElement.scrollTop+rawElement.offsetHeight+5>=rawElement.scrollHeight&&$scope.nextChunkMethod&&$scope.$apply(function(){for(var i=0;i<$scope.numberOfLoadedChunksPerScroll;i++)$scope.nextChunkMethod()}),0===rawElement.scrollTop&&$scope.previousChunkMethod&&$scope.$apply(function(){for(var chunkSize=0,i=0;i<$scope.numberOfLoadedChunksPerScroll;i++)chunkSize+=$scope.previousChunkMethod();if(chunkSize)rawElement.scrollTop=chunkSize;else{var previousHeight=rawElement.scrollHeight;setTimeout(function(){rawElement.scrollTop=rawElement.scrollHeight-previousHeight},0)}})})})}}}),angular.module("calendar-templates",["views/calendar.html"]),angular.module("views/calendar.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("views/calendar.html",'<div class=cf-calendar-container><table class="cf-calendar-header cf-view-calendar"><tr><th class=cf-day>Sun</th><th class=cf-day>Mon</th><th class=cf-day>Tue</th><th class=cf-day>Wed</th><th class=cf-day>Thu</th><th class=cf-day>Fri</th><th class=cf-day>Sat</th><th class=cf-month>Month</th></tr></table><div class=cf-view-calendar-wrapper scroller previous-chunk-method=loadPreviousMonth next-chunk-method=loadNextMonth number-of-loaded-chunks-per-scroll=1 on-scroll=onScroll ng-class="{\'cf-invisible\': !showCalendar}"><table class=cf-view-calendar ng-class="{\'cf-hoverable\': showHover}"><tr ng-repeat="week in calendar" ng-class="{\n                \'cf-first\': week.firstOfTheMonth,\n                \'cf-week\': true,\n                \'cf-pending\': week.pending || !week.loaded\n            }"><td class=cf-day ng-repeat="day in week.days" day-tooltip={{showTooltip}} ng-attr-title={{tooltip(day)}} ng-mousedown="onMouseDown(day, $event)" ng-mouseup="onMouseUp(day, $event)" ng-mouseenter="onMouseEnter(day, $event)" ng-class="cellClass(day, week)">{{day.date.getDate()}}</td><td ng-if=week.firstOfTheMonth rowspan={{week.month.nweeks}} ng-class="{\n                    \'cf-month\': true,\n                    \'cf-even\': week.month.number % 2 == 0,\n                    \'cf-odd\': week.month.number % 2 == 1,\n                }">{{week.month.name}}<br>{{week.month.year}}</td></tr></table></div></div>')}]);